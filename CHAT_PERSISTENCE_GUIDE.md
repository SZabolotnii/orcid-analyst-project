# 💬 Збереження історії чату - Технічна документація

## ✨ Що реалізовано

### 1. **Персистентність між вкладками**
Історія чату зберігається при перемиканні між "Ручний аналіз" ↔ "AI Асистент"

### 2. **Збереження в localStorage**
Історія автоматично зберігається в браузері і відновлюється після перезавантаження сторінки

### 3. **Кнопка "Нова розмова"**
Користувач сам вирішує, коли очистити історію

---

## 🏗️ Технічна реалізація

### Архітектура стану

```
Home.jsx (батьківський компонент)
├── chatMessages (useState) - головний стан історії
├── localStorage sync (useEffect) - автозбереження
└── ChatInterface (дочірній компонент)
    ├── messages (prop) - читання історії
    └── setMessages (prop) - запис нових повідомлень
```

### Код в Home.jsx

```jsx
import React, { useState, useEffect } from 'react';

export default function Home() {
    // Ініціалізація з localStorage
    const [chatMessages, setChatMessages] = useState(() => {
        try {
            const saved = localStorage.getItem('orcid-chat-history');
            return saved ? JSON.parse(saved) : [];
        } catch (error) {
            console.error('Failed to load chat history:', error);
            return [];
        }
    });

    // Автозбереження при кожній зміні
    useEffect(() => {
        try {
            localStorage.setItem('orcid-chat-history', JSON.stringify(chatMessages));
        } catch (error) {
            console.error('Failed to save chat history:', error);
        }
    }, [chatMessages]);

    return (
        <ChatInterface 
            messages={chatMessages}
            setMessages={setChatMessages}
            analysisResult={analysisResult}
            groupResult={groupResult}
        />
    );
}
```

### Код в ChatInterface.jsx

```jsx
export default function ChatInterface({ 
    analysisResult, 
    groupResult, 
    messages,      // ← з батьківського компонента
    setMessages    // ← з батьківського компонента
}) {
    // Очищення історії
    const handleClearChat = () => {
        if (window.confirm('Розпочати нову розмову? Поточна історія буде видалена.')) {
            setMessages([]);
            setStreamingText('');
        }
    };

    // Додавання повідомлення
    const handleSend = async () => {
        setMessages(prev => [...prev, { 
            role: 'user', 
            content: userMessage 
        }]);
        // ...
    };
}
```

---

## 🎯 Поведінка інтерфейсу

### Сценарій 1: Перемикання вкладок

```
1. Користувач на "AI Асистент"
   ├── Пише запитання
   └── Отримує відповідь

2. Переходить на "Ручний аналіз"
   └── Виконує новий ORCID аналіз

3. Повертається на "AI Асистент"
   ✅ Історія чату збережена!
   ✅ Нові дані аналізу доступні
   ✅ З'являється кнопка "Нова розмова"
```

### Сценарій 2: Перезавантаження сторінки

```
1. Користувач закриває браузер
2. Відкриває додаток знову
   ✅ Історія чату відновлена з localStorage
   ⚠️ Дані аналізу НЕ збережені (за дизайном)
```

### Сценарій 3: Очищення історії

```
Кнопка "Нова розмова" з'являється коли:
1. Є завантажені дані аналізу + є повідомлення
2. Немає даних аналізу, але є повідомлення

Натискання:
├── Показує підтвердження
├── Очищує messages[] в стані
├── Очищає localStorage
└── Скидає streamingText
```

---

## 📊 Візуальні індикатори

### 1. Коли є дані + історія

```
┌─────────────────────────────────────────────────────┐
│ 📊 Дані завантажено: ORCID XXX • 45 публікацій     │
│                            [🔄 Нова розмова] ← кнопка│
└─────────────────────────────────────────────────────┘
```

### 2. Коли історія без даних

```
┌─────────────────────────────────────────────────────┐
│ Історія розмови збережена   [🔄 Нова розмова]      │
└─────────────────────────────────────────────────────┘
```

### 3. Порожній стан

```
        🔮 AI-аналітик публікацій
        
        [Підказка 1]  [Підказка 2]
        [Підказка 3]  [Підказка 4]
```

---

## 🔑 Ключові переваги

### ✅ Для користувача
- Не втрачає контекст при перемиканні вкладок
- Може продовжити розмову після перезавантаження
- Контролює, коли розпочати нову розмову
- Бачить індикатори стану історії

### ✅ Для розробника
- Централізований стан у батьківському компоненті
- Автоматичне збереження без ручних викликів
- Обробка помилок localStorage (try/catch)
- Чистий код без дублювання логіки

### ✅ Для AI
- Зберігається весь контекст діалогу
- Доступ до попередніх запитань/відповідей
- Краща якість відповідей завдяки історії

---

## 🧪 Тестування

### Тест 1: Збереження між вкладками

```bash
1. Відкрийте "AI Асистент"
2. Напишіть будь-яке повідомлення
3. Переключіться на "Ручний аналіз"
4. Поверніться на "AI Асистент"

Очікується: Повідомлення залишилось на місці ✅
```

### Тест 2: localStorage персистентність

```bash
1. Напишіть кілька повідомлень у чаті
2. Натисніть F5 (перезавантажити сторінку)

Очікується: Історія відновлена після перезавантаження ✅
```

### Тест 3: Кнопка "Нова розмова"

```bash
1. Створіть історію з кількома повідомленнями
2. Натисніть "Нова розмова"
3. Підтвердіть у діалоговому вікні

Очікується: 
- Історія очищена ✅
- localStorage очищено ✅
- Показано порожній стан з підказками ✅
```

### Тест 4: Інтеграція з даними аналізу

```bash
1. Виконайте ORCID аналіз на першій вкладці
2. Перейдіть на "AI Асистент"
3. Запитайте про дані
4. Виконайте новий аналіз на першій вкладці
5. Поверніться на "AI Асистент"

Очікується:
- Історія збережена ✅
- Нові дані доступні AI ✅
- Банер оновився з новими даними ✅
- Кнопка "Нова розмова" видима ✅
```

---

## 🔍 localStorage структура

### Ключ
```
orcid-chat-history
```

### Формат даних
```json
[
  {
    "role": "user",
    "content": "Проаналізуй ці дані"
  },
  {
    "role": "assistant",
    "content": "На основі аналізу ORCID 0000-0002-1825-0097..."
  }
]
```

### Розмір
- Типова історія 50 повідомлень: ~20-50KB
- localStorage ліміт: 5-10MB (залежить від браузера)
- Достатньо для сотень діалогів

---

## 🚨 Обмеження і edge cases

### 1. localStorage недоступний
```javascript
try {
    localStorage.setItem('orcid-chat-history', JSON.stringify(messages));
} catch (error) {
    // Працює в приватному режимі Safari
    // Працює коли localStorage вимкнено
    console.error('Failed to save chat history:', error);
}
```

### 2. Дані аналізу не зберігаються
```
Чому? 
- Дані можуть бути великими (тисячі публікацій)
- ORCID API безкоштовний, можна перезавантажити
- Користувач може аналізувати різні ID

Як працює?
- Після перезавантаження: історія є, дані ні
- Користувач може виконати аналіз знову
- AI отримає нові дані автоматично
```

### 3. Конфлікт між вкладками браузера
```
Що буде?
- localStorage спільний для всіх вкладок
- Остання вкладка "виграє" при збереженні

Вирішення:
- Для MVP: нормальна поведінка
- Для продакшену: використати sessionStorage або IndexedDB
```

---

## 🎨 UI/UX покращення

### Реалізовано
- ✅ Індикатор "Історія розмови збережена"
- ✅ Кнопка "Нова розмова" з підтвердженням
- ✅ Динамічні підказки (змінюються залежно від контексту)
- ✅ Візуальні іконки (Database/Users)

### Можна додати в майбутньому
- [ ] Лічильник повідомлень у заголовку
- [ ] Експорт історії в файл
- [ ] Пошук по історії
- [ ] Мультисесійність (декілька збережених діалогів)
- [ ] Timestamp для кожного повідомлення
- [ ] Індикатор розміру історії

---

## 📝 Висновок

Система збереження історії чату забезпечує:
- 🔄 Безперервний UX при навігації
- 💾 Персистентність даних
- 🎯 Контроль користувача
- 🏗️ Чистий код

Користувач **ніколи не втратить** історію діалогу випадково! 🎉

